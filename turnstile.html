<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人机验证组件</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .turnstile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .turnstile-modal {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 350px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .turnstile-header {
            background-color: #f5f5f5;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .turnstile-body {
            padding: 24px;
            text-align: center;
        }

        .turnstile-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            background-color: #f38020;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .turnstile-message {
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
        }

        .turnstile-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
        }

        .turnstile-button {
            background-color: #f38020;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
        }

        .turnstile-button:hover {
            background-color: #e6731b;
        }

        .turnstile-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .turnstile-footer {
            padding: 12px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #e0e0e0;
        }

        .turnstile-success {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 16px;
            display: none;
        }

        .turnstile-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        .turnstile-loading {
            display: none;
            margin: 16px auto;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f38020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .turnstile-behavior-data {
            display: none;
        }
    </style>
</head>

<body>
    <div class="turnstile-modal">
        <div class="turnstile-header">
            <div class="turnstile-logo">✓</div>
            <h3>人机验证</h3>
        </div>
        <div class="turnstile-body">
            <p class="turnstile-message">请确认您不是机器人</p>
            <input type="text" class="turnstile-input" id="humanInput" placeholder="输入“我不是机器人”以验证" />
            <button class="turnstile-button" id="verifyButton">验证</button>
            <div class="turnstile-loading" id="loadingIndicator"></div>
            <p class="turnstile-success" id="successMessage">验证成功！正在加载内容...</p>
            <p class="turnstile-error" id="errorMessage">验证失败，请重试</p>
            <div class="turnstile-behavior-data" id="behaviorData"></div>
        </div>
        <div class="turnstile-footer">
            由安全验证系统提供保护
        </div>
    </div>

    <script>
        // 主验证类
        class TurnstileVerification {
            constructor() {
                this.behaviorScore = 0;
                this.maxScore = 100;
                this.passingScore = 80; // 提高通过分数阈值
                this.verificationPassed = false;
                this.behaviorData = {
                    mouseMovements: [],
                    clicks: [],
                    scrolls: [],
                    keyPresses: [],
                    deviceInfo: {},
                    networkRequests: [],
                    interactionTiming: []
                };

                this.initElements();
                this.setupEventListeners();
                this.collectDeviceFingerprint();
                this.monitorNetworkRequests();
                this.startInteractionTiming();

                // 尝试无感验证
                setTimeout(() => this.tryPassiveVerification(), 2000);
            }

            initElements() {
                this.humanInput = document.getElementById('humanInput');
                this.verifyButton = document.getElementById('verifyButton');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.successMessage = document.getElementById('successMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.behaviorDataElement = document.getElementById('behaviorData');
            }

            setupEventListeners() {
                // 鼠标移动跟踪 - 使用节流优化性能
                this.throttledMouseMove = this.throttle((e) => {
                    this.recordMouseMovement(e);
                }, 50);
                document.addEventListener('mousemove', this.throttledMouseMove);

                // 点击跟踪
                document.addEventListener('click', (e) => {
                    this.recordClick(e);
                });

                // 滚动跟踪 - 使用节流
                this.throttledScroll = this.throttle((e) => {
                    this.recordScroll(e);
                }, 100);
                window.addEventListener('scroll', this.throttledScroll, { passive: true });

                // 键盘输入跟踪
                document.addEventListener('keydown', (e) => {
                    this.recordKeyPress(e);
                });

                // 验证按钮点击
                this.verifyButton.addEventListener('click', () => {
                    this.verifyHuman();
                });

                // 输入框输入验证
                this.humanInput.addEventListener('input', () => {
                    this.recordInputBehavior();
                });

                // 添加指针事件支持
                document.addEventListener('pointermove', this.throttledMouseMove);
                document.addEventListener('pointerdown', (e) => {
                    this.recordClick(e);
                });
            }

            // 节流函数优化性能
            throttle(func, limit) {
                let lastFunc;
                let lastRan;
                return function () {
                    const context = this;
                    const args = arguments;
                    if (!lastRan) {
                        func.apply(context, args);
                        lastRan = Date.now();
                    } else {
                        clearTimeout(lastFunc);
                        lastFunc = setTimeout(function () {
                            if ((Date.now() - lastRan) >= limit) {
                                func.apply(context, args);
                                lastRan = Date.now();
                            }
                        }, limit - (Date.now() - lastRan));
                    }
                };
            }

            // 记录交互时间
            startInteractionTiming() {
                this.behaviorData.interactionStart = Date.now();
                this.behaviorData.lastActiveTime = Date.now();

                // 定期记录活动状态
                this.inactivityTimer = setInterval(() => {
                    const now = Date.now();
                    this.behaviorData.interactionTiming.push({
                        time: now,
                        inactiveDuration: now - this.behaviorData.lastActiveTime
                    });
                }, 5000);
            }

            // 行为分析方法改进
            recordMouseMovement(e) {
                const now = Date.now();
                this.behaviorData.lastActiveTime = now;

                const movement = {
                    x: e.clientX,
                    y: e.clientY,
                    time: now,
                    speed: 0,
                    acceleration: 0,
                    pressure: e.pressure || 0,
                    pointerType: e.pointerType || 'mouse'
                };

                if (this.behaviorData.mouseMovements.length > 0) {
                    const last = this.behaviorData.mouseMovements[this.behaviorData.mouseMovements.length - 1];
                    const timeDiff = (now - last.time) / 1000;
                    if (timeDiff > 0) {
                        const distance = Math.sqrt(
                            Math.pow(movement.x - last.x, 2) +
                            Math.pow(movement.y - last.y, 2)
                        );
                        movement.speed = distance / timeDiff;

                        if (this.behaviorData.mouseMovements.length > 1) {
                            const lastSpeed = last.speed;
                            movement.acceleration = (movement.speed - lastSpeed) / timeDiff;
                        }
                    }
                }

                this.behaviorData.mouseMovements.push(movement);

                // 优化分析频率
                if (this.behaviorData.mouseMovements.length % 10 === 0) {
                    this.analyzeMouseBehavior();
                }
            }

            recordClick(e) {
                const now = Date.now();
                this.behaviorData.lastActiveTime = now;

                const click = {
                    x: e.clientX,
                    y: e.clientY,
                    time: now,
                    target: e.target.tagName,
                    pointerType: e.pointerType || 'mouse',
                    pressure: e.pressure || 0,
                    detail: e.detail // 点击次数（用于区分单击/双击）
                };

                if (this.behaviorData.clicks.length > 0) {
                    const lastClick = this.behaviorData.clicks[this.behaviorData.clicks.length - 1];
                    click.interval = now - lastClick.time;
                }

                this.behaviorData.clicks.push(click);
                this.analyzeClickPattern();
            }

            recordInputBehavior() {
                const now = Date.now();
                this.behaviorData.lastActiveTime = now;

                if (this.humanInput.value === "我不是机器人") {
                    this.behaviorScore += 15; // 提高正确输入的分数
                    // 分析输入速度
                    if (this.behaviorData.keyPresses.length >= 2) {
                        const firstKeyTime = this.behaviorData.keyPresses[0].time;
                        const lastKeyTime = this.behaviorData.keyPresses[this.behaviorData.keyPresses.length - 1].time;
                        const typingDuration = lastKeyTime - firstKeyTime;
                        const charsPerSecond = this.humanInput.value.length / (typingDuration / 1000);

                        // 人类通常输入速度为3-10字符/秒
                        if (charsPerSecond > 2 && charsPerSecond < 12) {
                            this.behaviorScore += 10;
                        }
                    }
                } else {
                    this.behaviorScore = Math.max(0, this.behaviorScore - 5); // 减少错误输入的惩罚
                }
            }

            // 改进的行为分析方法
            analyzeMouseBehavior() {
                const movements = this.behaviorData.mouseMovements;
                if (movements.length < 5) return;

                // 1. 检查鼠标速度变化
                const speeds = movements.map(m => m.speed).filter(s => s > 0);
                if (speeds.length > 1) {
                    const speedVariation = this.calculateVariation(speeds);
                    if (speedVariation > 0.6) {
                        this.behaviorScore += 8; // 人类鼠标移动速度变化较大
                    }

                    // 检查速度分布
                    const avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
                    if (avgSpeed > 100 && avgSpeed < 2000) { // 合理的人类鼠标速度范围
                        this.behaviorScore += 5;
                    }
                }

                // 2. 检查加速度模式
                const accelerations = movements.map(m => m.acceleration).filter(a => !isNaN(a));
                if (accelerations.length > 2) {
                    const accelerationPattern = this.detectPattern(accelerations);
                    if (accelerationPattern.regularity < 0.25) {
                        this.behaviorScore += 8; // 人类鼠标加速度不规则
                    }
                }

                // 3. 检查轨迹特征
                const recentMovements = movements.slice(-30);
                if (recentMovements.length > 3) {
                    // 3.1 直线性
                    const linearity = this.checkMovementLinearity(recentMovements);
                    if (linearity < 0.8) {
                        this.behaviorScore += 5;
                    }

                    // 3.2 曲率变化
                    const curvatureChanges = this.calculateCurvatureChanges(recentMovements);
                    if (curvatureChanges > 2) {
                        this.behaviorScore += 5;
                    }
                }

                // 4. 检查指针压力（支持压感设备）
                if (movements.some(m => m.pressure > 0 && m.pressure !== 1)) {
                    this.behaviorScore += 10; // 真实设备可能有压力变化
                }
            }

            // 新增方法：计算鼠标轨迹曲率变化
            calculateCurvatureChanges(movements) {
                if (movements.length < 3) return 0;

                let changes = 0;
                let lastAngle = null;

                for (let i = 1; i < movements.length - 1; i++) {
                    const prev = movements[i - 1];
                    const curr = movements[i];
                    const next = movements[i + 1];

                    // 计算三个连续点形成的角度
                    const angle = Math.atan2(next.y - curr.y, next.x - curr.x) -
                        Math.atan2(curr.y - prev.y, curr.x - prev.x);

                    if (lastAngle !== null && Math.abs(angle - lastAngle) > 0.2) {
                        changes++;
                    }
                    lastAngle = angle;
                }

                return changes;
            }

            // 改进的设备指纹检测
            collectDeviceFingerprint() {
                this.behaviorData.deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    colorDepth: window.screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    languages: navigator.languages,
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack || 'unspecified',
                    webglVendor: this.getWebGLInfo(),
                    canvasFingerprint: this.getCanvasFingerprint(),
                    audioContextFingerprint: this.getAudioContextFingerprint(),
                    fonts: this.detectInstalledFonts(),
                    plugins: this.getBrowserPlugins(),
                    touchSupport: 'ontouchstart' in window,
                    batteryApi: 'getBattery' in navigator,
                    // 新增指纹特征
                    devicePixelRatio: window.devicePixelRatio,
                    maxTouchPoints: navigator.maxTouchPoints || 0,
                    vibrateSupport: 'vibrate' in navigator,
                    notificationSupport: 'Notification' in window,
                    mediaDevicesSupport: 'mediaDevices' in navigator,
                    // 性能相关指标
                    performanceTiming: this.getPerformanceTiming(),
                    hardwareClass: this.detectHardwareClass()
                };

                this.analyzeDeviceFingerprint();
            }

            // 新增方法：检测硬件级别
            detectHardwareClass() {
                try {
                    // 根据设备内存和CPU核心数分类
                    const memory = this.behaviorData.deviceInfo.deviceMemory;
                    const cores = this.behaviorData.deviceInfo.hardwareConcurrency;

                    if (memory === 'unknown' || cores === 'unknown') return 'unknown';

                    if (memory >= 8 && cores >= 8) return 'high-end';
                    if (memory >= 4 && cores >= 4) return 'mid-range';
                    return 'low-end';
                } catch (e) {
                    return 'error';
                }
            }

            // 改进的设备指纹分析
            analyzeDeviceFingerprint() {
                const info = this.behaviorData.deviceInfo;
                let suspiciousFlags = 0;

                // 1. 检查自动化工具特征
                const ua = info.userAgent.toLowerCase();
                const automationKeywords = [
                    'headless', 'phantom', 'puppeteer',
                    'selenium', 'webdriver', 'crawler',
                    'bot', 'spider', 'scraper'
                ];

                if (automationKeywords.some(kw => ua.includes(kw))) {
                    suspiciousFlags += 2;
                }

                // 2. 检查WebGL支持
                if (!info.webglVendor || info.webglVendor === 'error') {
                    suspiciousFlags += 1;
                }

                // 3. 检查字体异常
                if (info.fonts.length < 5) {
                    suspiciousFlags += 1;
                }

                // 4. 检查插件异常
                if (info.plugins.length === 0 && navigator.plugins && navigator.plugins.length === 0) {
                    suspiciousFlags += 1;
                }

                // 5. 检查屏幕分辨率异常
                if (info.screenResolution === '0x0' ||
                    parseInt(info.screenResolution.split('x')[0]) > 10000) {
                    suspiciousFlags += 2;
                }

                // 6. 检查设备像素比异常
                if (info.devicePixelRatio < 0.5 || info.devicePixelRatio > 5) {
                    suspiciousFlags += 1;
                }

                // 7. 检查硬件信息一致性
                if (info.hardwareClass === 'high-end' && info.deviceMemory < 8) {
                    suspiciousFlags += 1;
                }

                // 根据可疑标志调整分数
                if (suspiciousFlags >= 3) {
                    this.behaviorScore = Math.max(0, this.behaviorScore - 30);
                } else if (suspiciousFlags > 0) {
                    this.behaviorScore = Math.max(0, this.behaviorScore - 10 * suspiciousFlags);
                } else {
                    // 正常设备加分
                    this.behaviorScore += 15;

                    // 移动设备额外验证
                    if (info.touchSupport || info.maxTouchPoints > 0) {
                        this.behaviorScore += 5;
                    }
                }
            }

            // 改进的验证流程
            verifyHuman() {
                // 检查输入是否正确
                if (this.humanInput.value !== "我不是机器人") {
                    this.showError("请输入正确的验证文本");
                    return;
                }

                this.showLoading();

                // 综合评分
                const finalScore = this.calculateFinalScore();

                // 模拟网络请求延迟
                setTimeout(() => {
                    if (finalScore >= this.passingScore) {
                        this.passVerification();
                    } else {
                        // 提供更详细的错误信息
                        let errorMsg = "验证失败，原因：";
                        if (this.behaviorData.mouseMovements.length < 10) {
                            errorMsg += "鼠标活动不足；";
                        }
                        if (this.behaviorData.keyPresses.length < 5) {
                            errorMsg += "键盘活动不足；";
                        }
                        if (this.behaviorData.deviceInfo.suspiciousFlags >= 3) {
                            errorMsg += "设备特征可疑；";
                        }

                        this.showError(errorMsg || "行为模式不符合人类特征");
                    }
                }, 1500);
            }

            // 清理事件监听器
            destroy() {
                document.removeEventListener('mousemove', this.throttledMouseMove);
                document.removeEventListener('pointermove', this.throttledMouseMove);
                window.removeEventListener('scroll', this.throttledScroll);
                clearInterval(this.inactivityTimer);
            }
        }

        // 初始化验证
        document.addEventListener('DOMContentLoaded', () => {
            const turnstile = new TurnstileVerification();

            // 暴露API供外部调用
            window.Turnstile = {
                getStatus: () => turnstile.getVerificationStatus(),
                reset: () => {
                    turnstile.destroy();
                    return new TurnstileVerification();
                }
            };
        });

    </script>
</body>

</html>