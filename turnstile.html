<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人机验证组件</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .turnstile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .turnstile-modal {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 320px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .turnstile-header {
            background-color: #f5f5f5;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .turnstile-body {
            padding: 24px;
            text-align: center;
        }

        .turnstile-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            background-color: #f38020;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .turnstile-message {
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
        }

        .turnstile-button {
            background-color: #f38020;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
            margin-bottom: 16px;
        }

        .turnstile-button:hover {
            background-color: #e6731b;
        }

        .turnstile-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .turnstile-footer {
            padding: 12px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #e0e0e0;
        }

        .turnstile-success {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 16px;
            display: none;
        }

        .turnstile-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        .turnstile-loading {
            display: none;
            margin: 16px auto;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f38020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .turnstile-behavior-data {
            display: none;
        }

        /* 拼图验证样式 */
        .puzzle-container {
            margin: 20px 0;
            position: relative;
        }

        .puzzle-image {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .puzzle-slider {
            width: 100%;
            height: 40px;
            background: #f0f0f0;
            border-radius: 20px;
            margin-top: 10px;
            position: relative;
        }

        .puzzle-slider-track {
            height: 100%;
            background: #e0e0e0;
            border-radius: 20px;
            width: calc(100% - 50px);
            margin: 0 auto;
            position: relative;
        }

        .puzzle-slider-thumb {
            width: 40px;
            height: 40px;
            background: #f38020;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            user-select: none;
        }

        .puzzle-slider-thumb:active {
            cursor: grabbing;
        }

        .puzzle-piece {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px dashed #f38020;
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .puzzle-success {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(76, 175, 80, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="turnstile-modal">
        <div class="turnstile-header">
            <div class="turnstile-logo">✓</div>
            <h3>人机验证</h3>
        </div>
        <div class="turnstile-body">
            <p class="turnstile-message" id="verificationMessage">请确认您不是机器人</p>
            <button class="turnstile-button" id="verifyButton">开始验证</button>

            <div id="puzzleChallenge" style="display: none;">
                <div class="puzzle-container">
                    <div class="puzzle-image" id="puzzleImage"></div>
                    <div class="puzzle-slider">
                        <div class="puzzle-slider-track">
                            <div class="puzzle-slider-thumb" id="sliderThumb">→</div>
                            <div class="puzzle-piece" id="puzzlePiece"></div>
                            <div class="puzzle-success" id="puzzleSuccess">✓</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="turnstile-loading" id="loadingIndicator"></div>
            <p class="turnstile-success" id="successMessage">验证成功！正在加载内容...</p>
            <p class="turnstile-error" id="errorMessage">验证失败，请重试</p>
            <div class="turnstile-behavior-data" id="behaviorData"></div>
        </div>
        <div class="turnstile-footer">
            由免费公益安全验证系统提供保护
        </div>
    </div>

    <script>
        // 主验证类
        class TurnstileVerification {
            constructor() {
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                this.verificationPassed = false;
                this.failedAttempts = 0;
                this.lastAttemptTime = 0;
                this.userInteracted = false;
                this.behaviorData = {
                    taps: [],
                    movements: [],
                    deviceInfo: {},
                    interactionTiming: {}
                };

                this.initElements();
                this.setupEventListeners();
                this.collectDeviceFingerprint();

                // 拼图验证相关
                this.puzzleTargetPosition = 0;
                this.isDragging = false;
                this.startX = 0;
                this.sliderLeft = 0;

                // 添加用户交互监听
                document.addEventListener('click', () => {
                    this.userInteracted = true;
                }, { once: true, passive: true });
            }

            initElements() {
                this.verifyButton = document.getElementById('verifyButton');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.successMessage = document.getElementById('successMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.verificationMessage = document.getElementById('verificationMessage');
                this.behaviorDataElement = document.getElementById('behaviorData');
                this.puzzleChallenge = document.getElementById('puzzleChallenge');
                this.puzzleImage = document.getElementById('puzzleImage');
                this.sliderThumb = document.getElementById('sliderThumb');
                this.puzzlePiece = document.getElementById('puzzlePiece');
                this.puzzleSuccess = document.getElementById('puzzleSuccess');
            }

            setupEventListeners() {
                // 点击跟踪
                document.addEventListener('click', (e) => {
                    this.recordTap(e);
                }, { passive: true });

                // 鼠标移动跟踪
                document.addEventListener('mousemove', (e) => {
                    this.recordMovement(e);
                }, { passive: true });

                // 验证按钮点击
                this.verifyButton.addEventListener('click', () => {
                    this.startVerification();
                }, { passive: true });

                // 拼图滑块事件
                this.sliderThumb.addEventListener('mousedown', (e) => {
                    this.startDrag(e);
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        this.dragSlider(e);
                    }
                }, { passive: true });

                document.addEventListener('mouseup', () => {
                    if (this.isDragging) {
                        this.endDrag();
                    }
                }, { passive: true });

                // 触摸事件支持
                this.sliderThumb.addEventListener('touchstart', (e) => {
                    this.startDrag(e.touches[0]);
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        e.preventDefault();
                        this.dragSlider(e.touches[0]);
                    }
                }, { passive: false });

                document.addEventListener('touchend', () => {
                    if (this.isDragging) {
                        this.endDrag();
                    }
                }, { passive: true });
            }

            recordTap(e) {
                const now = Date.now();
                const tap = {
                    x: e.clientX,
                    y: e.clientY,
                    time: now,
                    target: e.target.tagName
                };

                if (this.behaviorData.taps.length > 0) {
                    const lastTap = this.behaviorData.taps[this.behaviorData.taps.length - 1];
                    tap.interval = now - lastTap.time;
                }

                this.behaviorData.taps.push(tap);
            }

            recordMovement(e) {
                if (this.behaviorData.movements.length > 100) return;

                const now = Date.now();
                this.behaviorData.movements.push({
                    x: e.clientX,
                    y: e.clientY,
                    time: now
                });
            }

            collectDeviceFingerprint() {
                this.behaviorData.deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    colorDepth: window.screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    languages: navigator.languages,
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack || 'unspecified',
                    webglVendor: this.getWebGLInfo(),
                    canvasFingerprint: this.getCanvasFingerprint(),
                    audioContextFingerprint: this.getAudioFingerprint(),
                    fontFingerprint: this.getFontFingerprint(),
                    touchSupport: 'ontouchstart' in window,
                    performanceTiming: window.performance ? {
                        timing: window.performance.timing ?
                            Object.assign({}, window.performance.timing) : null,
                        memory: window.performance.memory
                    } : null
                };
            }

            getWebGLInfo() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) {
                        console.warn('WebGL not supported');
                        return 'unsupported';
                    }

                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (!debugInfo) {
                        console.warn('WEBGL_debug_renderer_info not available');
                        return 'no_debug_info';
                    }

                    return {
                        vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                        renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL),
                        parameters: {
                            MAX_TEXTURE_SIZE: gl.getParameter(gl.MAX_TEXTURE_SIZE),
                            MAX_RENDERBUFFER_SIZE: gl.getParameter(gl.MAX_RENDERBUFFER_SIZE),
                            UNMASKED_VENDOR_WEBGL: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                            UNMASKED_RENDERER_WEBGL: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                        }
                    };
                } catch (e) {
                    console.error('WebGL fingerprint error:', e);
                    return 'error';
                }
            }

            getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;

                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(0, 0, 50, 50);
                    ctx.fillStyle = '#069';
                    ctx.fillText('Canvas Fingerprint', 60, 15);

                    ctx.strokeStyle = 'rgb(120, 186, 176)';
                    ctx.beginPath();
                    ctx.moveTo(60, 30);
                    ctx.lineTo(120, 30);
                    ctx.lineTo(120, 40);
                    ctx.lineTo(60, 40);
                    ctx.closePath();
                    ctx.stroke();

                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                    gradient.addColorStop(0, '#ff0000');
                    gradient.addColorStop(0.5, '#00ff00');
                    gradient.addColorStop(1, '#0000ff');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(130, 0, 70, 50);

                    return canvas.toDataURL().slice(-32);
                } catch (e) {
                    return 'error';
                }
            }

            getAudioFingerprint() {
                try {
                    if (!this.userInteracted) {
                        return 'pending_user_interaction';
                    }

                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) {
                        return 'unsupported';
                    }

                    const audioContext = new AudioContext();
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            console.log('AudioContext resumed successfully');
                        }).catch(e => {
                            console.error('AudioContext resume failed:', e);
                            return 'error';
                        });
                    }

                    const oscillator = audioContext.createOscillator();
                    const analyser = audioContext.createAnalyser();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(analyser);
                    analyser.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'triangle';
                    oscillator.frequency.value = 10000;
                    gainNode.gain.value = 0;

                    oscillator.start();
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(data);
                    oscillator.stop();

                    setTimeout(() => {
                        audioContext.close();
                    }, 1000);

                    return Array.from(data).join(',');
                } catch (e) {
                    console.error('Audio fingerprint error:', e);
                    return 'error';
                }
            }

            getFontFingerprint() {
                const fonts = [
                    'Arial', 'Arial Black', 'Courier New', 'Times New Roman',
                    'Comic Sans MS', 'Georgia', 'Impact', 'Tahoma',
                    'Trebuchet MS', 'Verdana', '微软雅黑', '宋体'
                ];

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 150;

                const availableFonts = [];
                const baseString = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';

                fonts.forEach(font => {
                    ctx.font = '72px ' + font + ', monospace';
                    const text1 = ctx.measureText(baseString).width;
                    ctx.font = '72px monospace';
                    const text2 = ctx.measureText(baseString).width;

                    if (text1 !== text2) {
                        availableFonts.push(font);
                    }
                });

                return availableFonts;
            }

            startVerification() {
                this.behaviorData.interactionTiming.start = Date.now();

                const now = Date.now();
                if (now - this.lastAttemptTime < 1000) {
                    this.showError("操作过于频繁，请稍后再试");
                    return;
                }

                if (this.failedAttempts >= 3) {
                    this.showError("验证失败次数过多，请刷新页面重试");
                    this.verifyButton.disabled = true;
                    return;
                }

                this.lastAttemptTime = now;
                this.showLoading();

                const delay = 1000 + (this.failedAttempts * 500);

                setTimeout(() => {
                    const isSuspicious = this.checkDeviceFingerprint();

                    if (!isSuspicious) {
                        this.initPuzzleChallenge();
                    } else {
                        this.failedAttempts++;
                        const remainingAttempts = 10 - this.failedAttempts;
                        this.showError(`验证失败，剩余尝试次数: ${remainingAttempts}`);

                        if (this.failedAttempts >= 10) {
                            this.verifyButton.disabled = true;
                        }
                    }
                }, delay);
            }

            initPuzzleChallenge() {
                this.loadingIndicator.style.display = 'none';
                this.verifyButton.style.display = 'none';
                this.puzzleChallenge.style.display = 'block';
                this.verificationMessage.textContent = '请完成拼图验证';

                this.puzzleTargetPosition = Math.floor(Math.random() * 30) + 60;

                const puzzleImages = [
                    './puzzle1.jpg',
                    './puzzle2.jpg',
                    './puzzle3.jpg'
                ];
                const randomImage = puzzleImages[Math.floor(Math.random() * puzzleImages.length)];
                this.puzzleImage.style.backgroundImage = `url(${randomImage})`;

                const sliderTrack = this.sliderThumb.parentElement;
                const trackRect = sliderTrack.getBoundingClientRect();
                this.sliderLeft = trackRect.left;

                this.puzzlePiece.style.left = `${this.puzzleTargetPosition}%`;
            }

            startDrag(e) {
                this.isDragging = true;
                this.startX = e.clientX - this.sliderThumb.getBoundingClientRect().left;
                this.sliderThumb.style.cursor = 'grabbing';
            }

            dragSlider(e) {
                if (!this.isDragging) return;

                const sliderTrack = this.sliderThumb.parentElement;
                const trackWidth = sliderTrack.offsetWidth - this.sliderThumb.offsetWidth;
                let newLeft = e.clientX - this.sliderLeft - this.startX;

                newLeft = Math.max(0, Math.min(newLeft, trackWidth));

                this.sliderThumb.style.left = `${newLeft}px`;

                const thumbPosition = (newLeft / trackWidth) * 100;
                if (Math.abs(thumbPosition - this.puzzleTargetPosition) < 5) {
                    this.puzzleSuccess.style.display = 'flex';
                    this.sliderThumb.style.backgroundColor = '#4CAF50';

                    setTimeout(() => {
                        this.passVerification();
                    }, 500);
                }
            }

            endDrag() {
                this.isDragging = false;
                this.sliderThumb.style.cursor = 'grab';
                this.puzzleSuccess.style.display = 'none';
                this.sliderThumb.style.backgroundColor = '#f38020';
            }

            checkDeviceFingerprint() {
                const ua = this.behaviorData.deviceInfo.userAgent.toLowerCase();
                const perf = window.performance;

                const headlessIndicators = [
                    'headless', 'phantom', 'puppeteer', 'selenium',
                    'crawler', 'spider', 'bot', 'automation'
                ];

                if (headlessIndicators.some(ind => ua.includes(ind))) {
                    return true;
                }

                if (!this.behaviorData.deviceInfo.webglVendor ||
                    this.behaviorData.deviceInfo.webglVendor === 'error' ||
                    this.behaviorData.deviceInfo.webglVendor === 'no_debug_info') {
                    return true;
                }

                if (window.screen.width < 200 || window.screen.height < 200) {
                    return true;
                }

                if (navigator.plugins.length === 0 && !this.isMobile) {
                    return true;
                }

                const timezone = this.behaviorData.deviceInfo.timezone;
                if (!timezone || timezone === 'Etc/UTC' || timezone === 'UTC') {
                    return true;
                }

                const cores = this.behaviorData.deviceInfo.hardwareConcurrency;
                if (cores === 1 || cores > 16) {
                    return true;
                }

                const memory = this.behaviorData.deviceInfo.deviceMemory;
                if (memory < 1 || memory > 16) {
                    return true;
                }

                const hasTouch = this.behaviorData.deviceInfo.touchSupport;
                if (this.isMobile && !hasTouch) {
                    return true;
                }

                if (this.behaviorData.taps.length < 3) {
                    return true;
                }

                if (this.behaviorData.deviceInfo.fontFingerprint.length < 5) {
                    return true;
                }

                return false;
            }

            showLoading() {
                this.verifyButton.disabled = true;
                this.loadingIndicator.style.display = 'block';
                this.errorMessage.style.display = 'none';
                this.puzzleChallenge.style.display = 'none';
            }

            showError(message) {
                this.verifyButton.disabled = false;
                this.loadingIndicator.style.display = 'none';
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.puzzleChallenge.style.display = 'none';
            }

            passVerification() {
                this.behaviorData.interactionTiming.end = Date.now();
                this.behaviorData.interactionTiming.duration =
                    this.behaviorData.interactionTiming.end - this.behaviorData.interactionTiming.start;

                this.verificationPassed = true;
                this.loadingIndicator.style.display = 'none';
                this.successMessage.style.display = 'block';
                this.verifyButton.style.display = 'none';
                this.puzzleChallenge.style.display = 'none';

                const token = this.generateVerificationToken();

                window.parent.postMessage(
                    {
                        type: 'turnstileVerified',
                        success: true,
                        token: token,
                        timestamp: Date.now()
                    },
                    '*'
                );

                setTimeout(() => {
                    const event = new CustomEvent('turnstileVerified', {
                        detail: { success: true }
                    });
                    document.dispatchEvent(event);
                }, 2000);
            }

            generateVerificationToken() {
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(2, 15);
                const fingerprintHash = this.hashString(JSON.stringify(this.behaviorData.deviceInfo));

                return `${timestamp}-${randomStr}-${fingerprintHash.slice(0, 8)}`;
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            }

            getVerificationStatus() {
                return {
                    verified: this.verificationPassed,
                    data: this.behaviorData
                };
            }
        }

        // 初始化验证
        document.addEventListener('DOMContentLoaded', () => {
            const turnstile = new TurnstileVerification();

            // 暴露API供外部调用
            window.Turnstile = {
                getStatus: () => turnstile.getVerificationStatus()
            };
        });
    </script>

</body>

</html>