<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人机验证组件</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .turnstile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .turnstile-modal {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 320px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .turnstile-header {
            background-color: #f5f5f5;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .turnstile-body {
            padding: 24px;
            text-align: center;
        }

        .turnstile-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            background-color: #f38020;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .turnstile-message {
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
        }

        .turnstile-button {
            background-color: #f38020;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
            margin-bottom: 16px;
        }

        .turnstile-button:hover {
            background-color: #e6731b;
        }

        .turnstile-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .turnstile-footer {
            padding: 12px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #e0e0e0;
        }

        .turnstile-success {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 16px;
            display: none;
        }

        .turnstile-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        .turnstile-loading {
            display: none;
            margin: 16px auto;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f38020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .turnstile-behavior-data {
            display: none;
        }
        
        .turnstile-puzzle {
            margin: 20px 0;
            display: none;
        }
        
        .puzzle-container {
            position: relative;
            height: 60px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .puzzle-slider {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: #f38020;
            border-radius: 4px;
            cursor: grab;
            z-index: 2;
        }
        
        .puzzle-track {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
        }
        
        .puzzle-target {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 4px;
            opacity: 0.7;
        }
        
        .puzzle-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="turnstile-modal">
        <div class="turnstile-header">
            <div class="turnstile-logo">✓</div>
            <h3>人机验证</h3>
        </div>
        <div class="turnstile-body">
            <p class="turnstile-message">请确认您不是机器人</p>
            <button class="turnstile-button" id="verifyButton">我不是机器人</button>
            
            <div class="turnstile-puzzle" id="puzzleChallenge">
                <div class="puzzle-container">
                    <div class="puzzle-track"></div>
                    <div class="puzzle-target"></div>
                    <div class="puzzle-slider" id="puzzleSlider"></div>
                </div>
                <div class="puzzle-text">请拖动滑块到右侧目标位置</div>
            </div>
            
            <div class="turnstile-loading" id="loadingIndicator"></div>
            <p class="turnstile-success" id="successMessage">验证成功！正在加载内容...</p>
            <p class="turnstile-error" id="errorMessage">验证失败，请重试</p>
            <div class="turnstile-behavior-data" id="behaviorData"></div>
        </div>
        <div class="turnstile-footer">
            由安全验证系统提供保护
        </div>
    </div>

<script>
    // 安全配置
    const SECURITY = {
        ENCRYPTION_KEY: 'secure_key_' + Math.random().toString(36).substring(2, 15),
        TOKEN_EXPIRY: 300000,
        PUZZLE_REQUIRE_ATTEMPTS: 2
    };

    // 获取父窗口信息
    const urlParams = new URLSearchParams(window.location.search);
    const parentHost = urlParams.get('host') || 'unknown';
    const referrer = urlParams.get('ref') || 'direct';

    class TurnstileVerification {
        constructor() {
            this.sessionId = this.generateSessionId();
            this.verificationPassed = false;
            this.attempts = 0;
            this.securityChecks = {
                behaviorAnalysis: false,
                deviceFingerprint: false,
                puzzleComplete: false,
                timingCheck: false
            };

            this.initElements();
            this.setupEventListeners();
            this.startSecurityChecks();
        }

        initElements() {
            this.verifyButton = document.getElementById('verifyButton');
            this.loadingIndicator = document.getElementById('loadingIndicator');
            this.successMessage = document.getElementById('successMessage');
            this.errorMessage = document.getElementById('errorMessage');
            this.puzzleChallenge = document.getElementById('puzzleChallenge');
            this.puzzleSlider = document.getElementById('puzzleSlider');
        }

        generateSessionId() {
            return 'sess_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 10);
        }

        setupEventListeners() {
            document.addEventListener('click', (e) => this.recordInteraction('click', e));
            document.addEventListener('mousemove', (e) => this.recordInteraction('move', e));
            document.addEventListener('keydown', (e) => this.recordInteraction('keydown', e));
            
            this.verifyButton.addEventListener('click', () => this.startVerification());
            this.setupPuzzleSlider();
        }

        startSecurityChecks() {
            this.checkDeviceFingerprint().then(result => {
                this.securityChecks.deviceFingerprint = !result.isSuspicious;
            });
            
            this.analyzeBehaviorPatterns();
            
            setInterval(() => {
                this.checkTimingPatterns();
            }, 1000);
        }

        async checkDeviceFingerprint() {
            const fingerprint = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                hardwareConcurrency: navigator.hardwareConcurrency,
                deviceMemory: navigator.deviceMemory,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                webgl: this.getWebGLInfo(),
                canvas: this.getCanvasFingerprint(),
                audio: await this.getAudioFingerprint(),
                touchSupport: 'ontouchstart' in window,
                plugins: this.getPluginsInfo()
            };
            
            return {
                fingerprint: fingerprint,
                isSuspicious: this.isSuspiciousDevice(fingerprint)
            };
        }

        isSuspiciousDevice(fingerprint) {
            const ua = fingerprint.userAgent.toLowerCase();
            return ua.includes('headless') || 
                   ua.includes('phantom') || 
                   ua.includes('puppeteer') || 
                   navigator.webdriver === true ||
                   fingerprint.hardwareConcurrency < 2 ||
                   fingerprint.deviceMemory < 2;
        }

        analyzeBehaviorPatterns() {
            setTimeout(() => {
                this.securityChecks.behaviorAnalysis = true;
            }, 2000);
        }

        checkTimingPatterns() {
            this.securityChecks.timingCheck = true;
        }

        setupPuzzleSlider() {
            let isDragging = false;
            let startX = 0;
            let startLeft = 0;
            let movementPattern = [];
            
            const slider = this.puzzleSlider;
            const container = slider.parentElement;
            const target = document.querySelector('.puzzle-target');
            
            slider.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startLeft = slider.offsetLeft;
                movementPattern = [{
                    type: 'start',
                    time: Date.now(),
                    x: e.clientX,
                    y: e.clientY
                }];
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                let newLeft = startLeft + dx;
                newLeft = Math.max(0, Math.min(newLeft, container.offsetWidth - slider.offsetWidth));
                slider.style.left = newLeft + 'px';
                
                movementPattern.push({
                    type: 'move',
                    time: Date.now(),
                    x: e.clientX,
                    y: e.clientY,
                    deltaX: dx
                });
            });
            
            document.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                movementPattern.push({
                    type: 'end',
                    time: Date.now(),
                    x: e.clientX,
                    y: e.clientY
                });
                
                const sliderRight = slider.offsetLeft + slider.offsetWidth;
                const targetRight = target.offsetLeft + target.offsetWidth;
                
                if (Math.abs(sliderRight - targetRight) < 5) {
                    this.securityChecks.puzzleComplete = this.analyzeMovement(movementPattern);
                    
                    if (this.securityChecks.puzzleComplete) {
                        this.completeVerification();
                    } else {
                        this.handleVerificationError("Suspicious movement detected");
                    }
                }
            });
        }

        analyzeMovement(pattern) {
            return pattern.length > 10 && Math.random() > 0.1;
        }

        startVerification() {
            this.attempts++;
            this.showLoading();
            
            setTimeout(() => {
                if (this.attempts >= SECURITY.PUZZLE_REQUIRE_ATTEMPTS) {
                    this.verifyButton.style.display = 'none';
                    this.puzzleChallenge.style.display = 'block';
                    this.hideLoading();
                } else {
                    this.completeVerification();
                }
            }, 1000);
        }

        completeVerification() {
            if (!this.allSecurityChecksPassed()) {
                this.handleVerificationError("Security checks failed");
                return;
            }
            
            this.verificationPassed = true;
            this.showSuccess();
            this.postVerificationResult(true);
            
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('turnstileComplete', {
                    detail: { success: true }
                }));
            }, 3000);
        }

        allSecurityChecksPassed() {
            return Object.values(this.securityChecks).every(check => check === true);
        }

        handleVerificationError(error) {
            this.showError(error);
            this.postVerificationResult(false, error);
            
            if (this.attempts >= SECURITY.MAX_ATTEMPTS) {
                setTimeout(() => location.reload(), 2000);
            }
        }

        postVerificationResult(success, error = null) {
            const message = {
                type: 'turnstileVerified',
                success: success,
                sessionId: this.sessionId,
                timestamp: Date.now(),
                host: parentHost,
                referrer: referrer,
                signature: this.createMessageSignature()
            };
            
            if (error) message.error = error;
            
            this.postMessageToParents(message);
        }

        createMessageSignature() {
            const str = 'turnstileVerified' + this.sessionId + Date.now();
            return btoa(encodeURIComponent(str + SECURITY.ENCRYPTION_KEY));
        }

        postMessageToParents(message) {
            try {
                if (window.parent) window.parent.postMessage(message, '*');
                if (window.top !== window.parent) window.top.postMessage(message, '*');
            } catch (e) {
                console.error('Error posting message:', e);
            }
        }

        showLoading() {
            this.loadingIndicator.style.display = 'block';
            this.errorMessage.style.display = 'none';
            this.verifyButton.disabled = true;
        }

        hideLoading() {
            this.loadingIndicator.style.display = 'none';
        }

        showSuccess() {
            this.loadingIndicator.style.display = 'none';
            this.errorMessage.style.display = 'none';
            this.successMessage.style.display = 'block';
            this.verifyButton.style.display = 'none';
            this.puzzleChallenge.style.display = 'none';
        }

        showError(message) {
            this.loadingIndicator.style.display = 'none';
            this.errorMessage.textContent = message;
            this.errorMessage.style.display = 'block';
            this.verifyButton.disabled = false;
        }

        getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return null;
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return debugInfo ? {
                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                } : null;
            } catch (e) {
                return null;
            }
        }

        getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 50;
                return canvas.toDataURL().slice(-32);
            } catch (e) {
                return null;
            }
        }

        async getAudioFingerprint() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return null;
                return 'audio_fingerprint';
            } catch (e) {
                return null;
            }
        }

        getPluginsInfo() {
            return Array.from(navigator.plugins).map(p => p.name);
        }

        recordInteraction(type, event) {
            // 交互记录逻辑
        }
    }

    // 初始化验证
    document.addEventListener('DOMContentLoaded', () => {
        new TurnstileVerification();
        
        // 安全防护
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key))) {
                e.preventDefault();
            }
        });
    });
</script>
</body>

</html>